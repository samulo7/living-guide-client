<template>
  <view class="page-container">
    <view class="nav-placeholder"></view>

    <scroll-view class="scroll-content" direction="vertical">
      <view class="hero-section">
        <image 
          class="hero-image" 
          :src="coverUrl" 
          mode="aspectFill"
          @error="onImageError"
        ></image>
        
        <view class="hero-overlay">
          <text class="hero-city">{{ cityItem.city }}</text>
          <text class="hero-district">{{ cityItem.district }}</text>
        </view>
        <view class="back-btn" @click="goBack">
          <text class="back-arrow">â†</text>
        </view>
      </view>

      <view class="dashboard-card">
        <view class="dashboard-header">
          <text class="section-title">ç”Ÿæ´»æˆæœ¬ & é…å¥—</text>
          <text class="update-time">æ›´æ–°äº {{ updateDate }}</text>
        </view>
        
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-label">æœˆç§Ÿé‡‘</text>
            <text class="stat-value price">Â¥{{ cityItem.price_rent }}</text>
          </view>
          <view class="stat-item">
            <text class="stat-label">ä¹°æˆ¿</text>
            <text class="stat-value">{{ cityItem.price_buy || 'æš‚æ— ' }}</text>
          </view>
          <view class="stat-item">
            <text class="stat-label">äº¤é€š</text>
            <text class="stat-value">{{ transportSummary }}</text>
          </view>
        </view>

        <view class="map-btn-wrap" v-if="hasLocation" @click="openMap">
          <text class="map-btn-text">ğŸ“ æŸ¥çœ‹åœ°å›¾ä½ç½®</text>
          <text class="map-arrow">></text>
        </view>
      </view>

      <view class="content-section">
        
        <view class="section-title-row">
            <text class="section-title-text">ğŸ¥ åŒ»ç–—ç¯å¢ƒè¯„ä¼°</text>
        </view>
        <view class="medical-card" :class="medicalInfo['bgClass']">
          <view class="medical-header">
            <text class="medical-icon">{{ medicalInfo['icon'] }}</text>
            <text class="medical-title">{{ medicalInfo['title'] }}</text>
          </view>
          <text class="medical-desc">{{ medicalInfo['desc'] }}</text>
          <view class="medical-divider"></view>
          <text class="medical-raw">é…ç½®è¯¦æƒ…: {{ cityItem.medical }}</text>
          <text class="medical-tips">{{ medicalInfo['tips'] }}</text>
        </view>

        <view class="guru-card" v-if="guruQuote">
          <view class="block-header">
            <text class="block-icon">ğŸ“</text> 
            <text class="block-title">å°ç¼–ç‚¹è¯„</text>
          </view>
          <text class="block-text">{{ guruQuote }}</text>
        </view>

        <view class="content-block climate-block" v-if="climateInfo">
          <view class="block-header">
            <text class="block-icon">ğŸŒ¤ï¸</text>
            <text class="block-title">æ°”å€™ä½“æ„Ÿ</text>
          </view>
          <text class="block-text">{{ climateInfo }}</text>
        </view>

        <view class="content-block cons-block" v-if="consInfo">
          <view class="block-header">
            <text class="block-icon">âš ï¸</text>
            <text class="block-title warning-text">æ³¨æ„/é¿å‘</text>
          </view>
          <text class="block-text">{{ consInfo }}</text>
        </view>
        
        <view style="height: 100px;"></view>
      </view>
    </scroll-view>

    <view class="footer-bar">
      <view class="action-btn btn-secondary" hover-class="btn-pressed" @click="openFeedbackModal">
        <text class="btn-text text-secondary">æˆ‘è¦çº é”™</text>
      </view>
      <view class="action-btn btn-primary" hover-class="btn-pressed">
        <text class="btn-text text-primary">æ”¶è—åŸå¸‚</text>
      </view>
    </view>

    <view class="modal-mask" v-if="showModal" @click="closeModal">
      <view class="modal-content" @click.stop>
        <view class="modal-header">
          <text class="modal-title">è¡¥å……åŸå¸‚ä¿¡æ¯</text>
          <text class="close-icon" @click="closeModal">âœ•</text>
        </view>
        <scroll-view class="modal-body" direction="vertical">
          <text class="form-label">çº é”™ç±»å‹</text>
          <view class="tags-container">
            <view class="form-tag" :class="{ 'tag-active': feedbackType === 'price' }" @click="feedbackType = 'price'">
              <text class="form-tag-text" :class="{ 'text-active': feedbackType === 'price' }">æ•°æ®è¿‡æœŸ</text>
            </view>
            <view class="form-tag" :class="{ 'tag-active': feedbackType === 'pitfall' }" @click="feedbackType = 'pitfall'">
              <text class="form-tag-text" :class="{ 'text-active': feedbackType === 'pitfall' }">ğŸ”¥ è¡¥å……æ§½ç‚¹</text>
            </view>
            <view class="form-tag" :class="{ 'tag-active': feedbackType === 'other' }" @click="feedbackType = 'other'">
              <text class="form-tag-text" :class="{ 'text-active': feedbackType === 'other' }">å…¶ä»–</text>
            </view>
          </view>
          <text class="form-label">è¯¦ç»†æè¿°</text>
          <textarea class="form-textarea" :placeholder="placeholderText" v-model="feedbackContent" :maxlength="200"></textarea>
          <text class="form-label">ä¸Šä¼ å‡­è¯ (é€‰å¡«)</text>
          <view class="upload-box">
            <text class="upload-icon">ğŸ“·</text>
            <text class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</text>
          </view>
        </scroll-view>
        <view class="modal-footer">
          <view class="submit-btn" hover-class="btn-pressed" @click="submitFeedback">
            <text class="submit-text">æäº¤å®¡æ ¸</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { loadCityData } from '../../utils/dataLoader'
import type { CityItem } from '../../types/city'
import { onLoad } from '@dcloudio/uni-app'

const emptyItem = {
  id: '', city: 'åŠ è½½ä¸­...', district: '', title: '',
  price_rent: 0, price_buy: '', tags: [] as string[], 
  medical: '', transport: '', cover_image: '', is_verified: false,
  detail: { guru_comment: '', climate_info: '', cons: '', medical_desc: '', transport_desc: '' },
  radar_data: { cost: 0, medical: 0, transport: 0, climate: 0, fun: 0 },
  location: { lat: 0, lng: 0 },
  has_hospital_class_a: false 
} as CityItem

const cityItem = ref<CityItem>(emptyItem)
const updateDate = ref('2026.01')
// âœ… ä¿®æ”¹ç‚¹ 2ï¼šæ–°å¢å›¾ç‰‡åŠ è½½é”™è¯¯çŠ¶æ€
const imgLoadError = ref(false)

onLoad(async (options) => {
  const id = options['id']
  if (id != null) { await initData(id as string) }
})

const initData = async (id: string) => {
  try {
    const data = await loadCityData()
    updateDate.value = data.update_date
    const found = data.items.find((item: CityItem): boolean => item.id == id)
    if (found != null) { 
      cityItem.value = found 
      // æ¯æ¬¡åŠ è½½æ–°æ•°æ®ï¼Œé‡ç½®é”™è¯¯çŠ¶æ€
      imgLoadError.value = false
    }
  } catch (e) { console.error('åŠ è½½è¯¦æƒ…å¤±è´¥', e) }
}

// âœ… ä¿®æ”¹ç‚¹ 3ï¼šæ™ºèƒ½å°é¢å›¾é€»è¾‘
const coverUrl = computed((): string => {
  // 1. å…ˆè®¡ç®—ä¸€ä¸ªå…œåº•çš„éšæœºå›¾ (1.jpg ~ 4.jpg)
  let idNum = 1
  try { 
    const str = cityItem.value.id
    const parsed = parseInt(str)
    if (!isNaN(parsed)) idNum = parsed
  } catch(e){}
  const index = (idNum % 4) + 1
  const fallbackUrl = `/static/images/${index}.jpg`

  // 2. å¦‚æœå‘ç”Ÿäº†åŠ è½½é”™è¯¯ï¼Œç›´æ¥è¿”å›å…œåº•å›¾
  if (imgLoadError.value) {
    return fallbackUrl
  }

  // 3. å¦‚æœæœ‰é…ç½®å›¾ç‰‡ï¼Œä¸”ä¸ä¸ºç©ºï¼Œå°è¯•æ˜¾ç¤ºé…ç½®çš„å›¾ç‰‡
  if (cityItem.value.cover_image && cityItem.value.cover_image.trim() !== "") {
    return cityItem.value.cover_image
  }

  // 4. é»˜è®¤è¿”å›å…œåº•å›¾
  return fallbackUrl
})

// âœ… ä¿®æ”¹ç‚¹ 4ï¼šå›¾ç‰‡åŠ è½½å¤±è´¥çš„å›è°ƒ
const onImageError = () => {
  console.log('âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢ä¸ºç¤ºä¾‹å›¾')
  imgLoadError.value = true
}

const transportSummary = computed(() => {
  const t = cityItem.value.transport || ''
  if (t.includes('é«˜é“')) return 'é«˜é“ç›´è¾¾'
  if (t.includes('æœºåœº')) return 'æœ‰æœºåœº'
  return 'ç«è½¦ç«™'
})

const hasLocation = computed((): boolean => {
  const loc = cityItem.value.location
  return loc.lat != 0 && loc.lng != 0
})

const openMap = () => {
  const loc = cityItem.value.location
  const name = cityItem.value.city + cityItem.value.district
  const url = `https://uri.amap.com/marker?position=${loc.lng},${loc.lat}&name=${name}&coordinate=gaode&callnative=1`
  uni.navigateTo({ url: `/pages/webview/webview?url=${encodeURIComponent(url)}` })
}

const guruQuote = computed(() => cityItem.value.detail?.guru_comment || '')
const climateInfo = computed(() => cityItem.value.detail?.climate_info || '')
const consInfo = computed(() => cityItem.value.detail?.cons || '')

const medicalInfo = computed(() => {
  if (!cityItem.value) return { bgClass: '', icon: '', title: '', desc: '', tips: '' }
  const has3A = cityItem.value.has_hospital_class_a
  if (has3A) {
    return { bgClass: 'bg-green', icon: 'âœ…', title: 'åŒ»ç–—èµ„æºï¼šå®Œå–„ (ä¸‰ç”²è¦†ç›–)', desc: 'åŒºåŸŸå†…é…æœ‰ä¸‰ç”²åŒ»é™¢ï¼ŒåŒ»ç–—ç¡¬ä»¶æ¡ä»¶è¾ƒå¥½ã€‚', tips: 'ğŸ’¡ é€‚å®œäººç¾¤ï¼šå…¨é¾„æ®µï¼ŒåŒ…å«è€äººã€æ…¢æ€§ç—…äººç¾¤æˆ–è¿½æ±‚å®‰å…¨æ„Ÿçš„ç‹¬å±…è€…ã€‚' }
  } else {
    return { bgClass: 'bg-gray', icon: 'âš ï¸', title: 'åŒ»ç–—èµ„æºï¼šåŸºç¡€ä¿éšœ', desc: 'æš‚æœªæ”¶å½•ä¸‰ç”²åŒ»é™¢ä¿¡æ¯ï¼Œä»¥ç¤¾åŒº/å¿çº§åŒ»é™¢ä¸ºä¸»ã€‚', tips: 'ğŸ’¡ é€‚å®œäººç¾¤ï¼šèº«ä½“å¥åº·çš„é’å£®å¹´ã€‚\nâš ï¸ æ³¨æ„ï¼šå¦‚éœ€é•¿æœŸå±…ä½ï¼Œå»ºè®®è‡ªå¤‡å¸¸ç”¨è¯ã€‚' }
  }
})

const goBack = () => uni.navigateBack({})

// --- å¼¹çª—é€»è¾‘ ---
const showModal = ref(false)
const feedbackType = ref('pitfall')
const feedbackContent = ref('')

const placeholderText = computed(() => {
  if (feedbackType.value === 'pitfall') {
    return 'ä¾‹å¦‚ï¼šå†¬å¤©æš–æ°”ä¸è¶³ã€å¤å¤©èšŠè™«å¤ªå¤šã€å¿«é€’ä¸åŒ…é‚®...ï¼ˆæ‚¨çš„åæ§½å°†å¸®åŠ©æ›´å¤šäººï¼‰'
  } else if (feedbackType.value === 'price') {
    return 'ä¾‹å¦‚ï¼šç°åœ¨æˆ¿ç§Ÿæ¶¨ä»·äº†ï¼Œå¤§æ¦‚ 800/æœˆ...'
  } else {
    return 'è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜...'
  }
})

const openFeedbackModal = () => {
  showModal.value = true
  feedbackType.value = 'pitfall'
  feedbackContent.value = ''
}

const closeModal = () => { showModal.value = false }

const submitFeedback = () => {
  if (feedbackContent.value.trim() === '') {
    uni.showToast({ title: 'è¯·å¡«å†™æè¿°å†…å®¹', icon: 'none' })
    return
  }
  uni.showLoading({ title: 'æäº¤ä¸­...', mask: true })
  setTimeout(() => {
    uni.hideLoading()
    console.log('ğŸ“ [æ–°ç”¨æˆ·æŠ•ç¨¿] ------------------------------')
    console.log('åŸå¸‚:', cityItem.value.city)
    console.log('ç±»å‹:', feedbackType.value === 'pitfall' ? 'è¡¥å……æ§½ç‚¹' : 'å…¶ä»–')
    console.log('å†…å®¹:', feedbackContent.value)
    console.log('--------------------------------------------')
    showModal.value = false
    uni.showToast({ title: 'æ„Ÿè°¢æäº¤ï¼å®¡æ ¸é€šè¿‡åå°†æ›´æ–°è‡³æŒ‡å—', icon: 'success', duration: 3000 })
    feedbackContent.value = ''
    feedbackType.value = 'pitfall'
  }, 1000)
}
</script>

<style scoped>
/* --- å¸ƒå±€åŸºç¡€ --- */
.page-container { flex: 1; background-color: #f5f7fa; height: 100vh; display: flex; flex-direction: column; }
.scroll-content { flex: 1; }
.hero-section { position: relative; height: 280px; width: 100%; }
.hero-image { width: 100%; height: 100%; }
.hero-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 30px 20px; background-image: linear-gradient(to top, rgba(0,0,0,0.7), transparent); }
.hero-city { font-size: 32px; font-weight: 900; color: #fff; }
.hero-district { font-size: 16px; color: rgba(255,255,255,0.9); margin-top: 4px; }
.back-btn { position: absolute; top: 50px; left: 20px; width: 40px; height: 40px; background-color: rgba(0,0,0,0.3); border-radius: 20px; justify-content: center; align-items: center; }
.back-arrow { color: #fff; font-size: 20px; font-weight: bold; }

/* --- æ ¸å¿ƒæ•°æ®å¡ç‰‡ --- */
.dashboard-card { margin: -20px 16px 0; background-color: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.06); position: relative; }
.dashboard-header { flex-direction: row; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.section-title { font-size: 18px; font-weight: bold; color: #333; }
.update-time { font-size: 12px; color: #999; }
.stats-grid { flex-direction: row; justify-content: space-between; }
.stat-item { align-items: center; flex: 1; }
.stat-label { font-size: 12px; color: #888; margin-bottom: 6px; }
.stat-value { font-size: 15px; font-weight: bold; color: #333; }
.price { color: #ff5500; font-size: 18px; }

/* åœ°å›¾æŒ‰é’® */
.map-btn-wrap {
  margin-top: 20px;
  background-color: #F7F8FA; 
  border-radius: 8px;
  padding: 12px;
  flex-direction: row;
  justify-content: center;
  align-items: center;
}
.map-btn-text { color: #5C8D89; font-size: 14px; font-weight: bold; }
.map-arrow { color: #5C8D89; font-size: 14px; margin-left: 4px; }

.content-section { padding: 20px 16px; }

/* --- åŒ»ç–—å¡ç‰‡ --- */
.section-title-row { margin-bottom: 12px; }
.section-title-text { font-size: 18px; font-weight: bold; color: #333; }
.medical-card { margin-bottom: 20px; padding: 16px; border-radius: 12px; }
.bg-green { background-color: #F1F8E9; border: 1px solid #DCEDC8; }
.bg-gray { background-color: #FAFAFA; border: 1px solid #EEEEEE; }
.medical-header { flex-direction: row; align-items: center; margin-bottom: 8px; }
.medical-icon { font-size: 18px; margin-right: 6px; }
.medical-title { font-size: 16px; font-weight: bold; color: #333; }
.medical-desc { font-size: 14px; color: #555; line-height: 1.5; margin-bottom: 8px; }
.medical-divider { height: 1px; background-color: rgba(0,0,0,0.05); margin: 8px 0; }
.medical-raw { font-size: 12px; color: #999; margin-bottom: 8px; }
.medical-tips { font-size: 13px; color: #666; background-color: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px; line-height: 1.6; }

/* --- âœ… å°ç¼–ç‚¹è¯„ (ç‹¬ç«‹ç±»åï¼Œç¡®ä¿ä¸è¢«æ±¡æŸ“) --- */
.guru-card {
 background-color: #F0F4F8;  /* æŸ”å’Œçš„è“ç°è‰² */
   border-radius: 12px;
   padding: 16px;
   margin-bottom: 16px;
   border: 1px solid #E0E7EE;
}

/* --- é€šç”¨å†…å®¹å— (æ°”å€™/å…¶ä»–) --- */
.content-block { 
  background-color: #fff; 
  border-radius: 12px; 
  padding: 16px; 
  margin-bottom: 16px; 
}
.block-header { flex-direction: row; align-items: center; margin-bottom: 10px; }
.block-icon { font-size: 18px; margin-right: 8px; }
.block-title { font-size: 16px; font-weight: bold; color: #333; }
.block-text { font-size: 15px; color: #555; line-height: 1.6; }

/* æ°”å€™ä½“æ„Ÿ (è“) */
.climate-block { background-color: #F0F9FF; border: 1px solid #E1F5FE; }
.climate-block .block-title, .climate-block .block-icon { color: #0288D1; }

/* é¿å‘æŒ‡å— (é»„) */
.cons-block { background-color: #FFFBE6; border: 1px solid #FFE58F; border-radius: 12px; padding: 16px; margin-bottom: 16px; margin-top: 24px; }
.cons-block .block-title, .cons-block .warning-text, .cons-block .block-icon { color: #D48806 !important; }
.cons-block .block-text { color: #555; }

/* --- åº•éƒ¨ & å¼¹çª— --- */
.footer-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background-color: #fff; border-top: 1px solid #f0f0f0; flex-direction: row; align-items: center; padding: 0 20px 20px; justify-content: space-between; gap: 12px; }
.action-btn { height: 44px; border-radius: 22px; justify-content: center; align-items: center; flex: 1; }
.btn-pressed { transform: scale(0.96); opacity: 0.9; transition-duration: 0.1s; }
.btn-secondary { background-color: #FFFFFF; border: 1px solid #E0E0E0; }
.text-secondary { color: #333333; font-size: 15px; font-weight: bold; }
.btn-primary { background-color: #5C8D89; border: none; }
.text-primary { color: #FFFFFF; font-size: 15px; font-weight: bold; }

.modal-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; display: flex; }
.modal-content { width: 300px; background-color: #fff; border-radius: 16px; overflow: hidden; padding-bottom: 20px; }
.modal-header { flex-direction: row; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #f0f0f0; }
.modal-title { font-size: 16px; font-weight: bold; color: #333; }
.close-icon { font-size: 20px; color: #999; padding: 4px; }
.modal-body { padding: 20px; max-height: 400px; }
.form-label { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px; margin-top: 10px; }
.form-label:first-child { margin-top: 0; }
.tags-container { flex-direction: row; flex-wrap: wrap; margin-bottom: 10px; }
.form-tag { padding: 6px 12px; background-color: #f5f5f5; border-radius: 20px; margin-right: 10px; margin-bottom: 10px; border: 1px solid transparent; }
.form-tag-text { font-size: 13px; color: #666; }
.tag-active { background-color: #E8F5E9; border-color: #5C8D89; }
.text-active { color: #5C8D89; font-weight: bold; }
.form-textarea { width: 100%; height: 100px; background-color: #f9f9f9; border-radius: 8px; padding: 10px; font-size: 14px; color: #333; }
.upload-box { width: 100px; height: 100px; background-color: #f9f9f9; border: 1px dashed #ddd; border-radius: 8px; justify-content: center; align-items: center; }
.upload-icon { font-size: 24px; color: #ccc; margin-bottom: 4px; }
.upload-text { font-size: 10px; color: #999; }
.modal-footer { padding: 0 20px; }
.submit-btn { height: 44px; background-color: #333; border-radius: 22px; justify-content: center; align-items: center; }
.submit-text { color: #fff; font-size: 15px; font-weight: bold; }
</style>