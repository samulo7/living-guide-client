<template>
  <view class="container">
    <view class="header">
      <view class="header-text">
        <text class="title">èººå¹³æŒ‡å—</text>
        <text class="subtitle">ä½æˆæœ¬æ—…å±…å†³ç­–å·¥å…·</text>
      </view>
    </view>

    <view class="search-section">
      <view class="search-bar">
        <text class="search-icon">ğŸ”</text>
        <input 
          class="search-input" 
          placeholder="æœç´¢åŸå¸‚ (å¦‚: é¹¤å²—)"
          v-model="keyword"
          @input="onSearch"
        />
      </view>
    </view>

    <scroll-view 
      class="quick-filter" 
      direction="horizontal" 
      :show-scrollbar="false"
    >
      <view class="filter-container">
        <view 
          v-for="filter in quickFilters" 
          :key="filter.value"
          class="filter-tag"
          :class="{ active: currentFilter === filter.value }"
          @click="onQuickFilter(filter.value)"
        >
          <text :class="['tag-text', currentFilter === filter.value ? 'active-text' : '']">
            {{ filter.label }}
          </text>
        </view>
        <view style="width: 20px; height: 10px;"></view>
      </view>
    </scroll-view>

    <view v-if="loading" class="loading-box">
      <text class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</text>
    </view>

    <scroll-view 
          v-else 
          class="city-list"
          direction="vertical"
        >
          <view v-if="filteredList.length === 0" class="empty-box">
            <text class="empty-text">æ²¡æ‰¾åˆ°ç»“æœï¼Œè¯•ç€æ¢ä¸ªè¯ï¼Ÿ</text>
          </view>
          
          <city-card
            v-for="item in filteredList"
            :key="item.id"
            :data="item"
            @click="goToDetail(item.id)"
          />
        </scroll-view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import CityCard from '../../components/CityCard.uvue'
import { loadCityData } from '../../utils/dataLoader.ts'
import type { CityItem } from '../../types/city'

// çŠ¶æ€ç®¡ç†
const allData = ref<CityItem[]>([])
const loading = ref(true)
const currentFilter = ref('all')
const keyword = ref('')

// ç­›é€‰é…ç½®
const quickFilters = [
  { label: 'å…¨éƒ¨', value: 'all' },
  { label: 'ğŸ’° ç§Ÿé‡‘<500', value: 'cheap' },
  { label: 'ğŸŒŠ æµ·è¾¹åŸå¸‚', value: 'seaside' },
  { label: 'ğŸŒ¸ å››å­£å¦‚æ˜¥', value: 'spring' },
  { label: 'ğŸ† UPä¸»å®æ¢', value: 'verified' }
]

// æ ¸å¿ƒç­›é€‰é€»è¾‘
const filteredList = computed(() => {
  let result = allData.value

  if (currentFilter.value === 'cheap') {
    result = result.filter(item => item.price_rent <= 500)
  } else if (currentFilter.value === 'seaside') {
    result = result.filter(item => item.tags.some(tag => tag.includes('æµ·') || tag.includes('æ°´')))
  } else if (currentFilter.value === 'spring') {
    result = result.filter(item => item.tags.some(tag => tag.includes('æ˜¥') || tag.includes('é¿æš‘')))
  } else if (currentFilter.value === 'verified') {
    result = result.filter(item => item.is_verified)
  }

  if (keyword.value.trim() !== '') {
    const kw = keyword.value.toLowerCase()
    result = result.filter(item => 
      item.city.toLowerCase().includes(kw) ||
      item.district.toLowerCase().includes(kw) ||
      item.tags.some(tag => tag.toLowerCase().includes(kw))
    )
  }
  
  // ä»·æ ¼æ’åº
  return [...result].sort((a, b) => a.price_rent - b.price_rent)
})

const onQuickFilter = (value: string) => currentFilter.value = value
const onSearch = () => {} // v-model è‡ªåŠ¨è§¦å‘
const goToDetail = (id: string) => uni.navigateTo({ url: `/pages/detail/detail?id=${id}` })

onMounted(async () => {
  try {
    const data = await loadCityData()
    allData.value = data.items
    loading.value = false
  } catch (error) {
    loading.value = false
  }
})
</script>

<style scoped>
.container {
  background-color: #f5f7fa;
    
    /* --- ä¿®å¤ç‚¹ Start --- */
    
    /* âŒ åˆ æ‰è¿™è¡Œï¼šmin-height: 100%; */
    /* âœ… æ”¹ä¸ºè¿™è¡Œï¼šå¼ºåˆ¶é«˜åº¦ç­‰äºå±å¹•é«˜åº¦ */
    height: 100vh; 
    
    /* âœ… å…³é”®ï¼šå¯ç”¨ Flex å¸ƒå±€ï¼Œè®©å†…éƒ¨çš„åˆ—è¡¨è‡ªåŠ¨å æ»¡å‰©ä½™ç©ºé—´ */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* é˜²æ­¢å®¹å™¨æœ¬èº«æº¢å‡º */
  
    /* --- é¢œå€¼ä¼˜åŒ–ä¿ç•™ --- */
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 0 20px rgba(0,0,0,0.05);
    /* --- ä¿®å¤ç‚¹ End --- */
}
.list-container {
  padding: 12px;
}

/* å¤´éƒ¨æ ·å¼ */
.header {
  background-image: linear-gradient(135deg, #749F82 0%, #5C8D89 100%);
  padding: 50px 20px 15px;
  align-items: flex-start;
}
.header-text { flex-direction: row; align-items: baseline; }
.title { font-size: 22px; font-weight: 900; color: #fff; margin-right: 10px; }
.subtitle { font-size: 13px; color: rgba(255,255,255,0.8); }

/* æœç´¢æ  */
.search-section { background-color: #fff; padding: 10px 16px; border-bottom: 1px solid #f0f0f0; }
.search-bar { background-color: #f5f5f5; height: 36px; border-radius: 18px; flex-direction: row; align-items: center; padding: 0 12px; }
.search-icon { font-size: 14px; margin-right: 8px; }
.search-input { flex: 1; font-size: 14px; color: #333; background-color: transparent; }

/* æ»šåŠ¨ç­›é€‰æ  */
.quick-filter { width: 100%; height: 50px; background-color: #fff; margin-bottom: 10px; flex-direction: row; }
.filter-container { display: flex; flex-direction: row; align-items: center; padding: 8px 16px; }
.filter-tag { flex-shrink: 0; padding: 6px 14px; margin-right: 10px; background-color: #f5f5f5; border-radius: 16px; border-width: 1px; border-style: solid; border-color: transparent; }
.filter-tag.active { background-color: #E8F5E9; border-color: #749F82; }
.tag-text { font-size: 13px; color: #666; }
.active-text { color: #426B50; font-weight: bold; }

.city-list { 
  /* âœ… æ ¸å¿ƒä¿®å¤ï¼šå æ®å‰©ä½™æ‰€æœ‰é«˜åº¦ */
  flex: 1;
  width: 100%;
  
  /* ä¿æŒåŸæœ‰çš„å†…è¾¹è· */
  padding: 0 16px 20px; 
}
.loading-box, .empty-box { padding: 50px 0; align-items: center; justify-content: center; }
.loading-text, .empty-text { font-size: 14px; color: #999; }
</style>