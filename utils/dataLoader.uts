// æ–‡ä»¶è·¯å¾„: /utils/dataLoader.uts
import { CityData } from '../types/city'

// å¸¸é‡å®šä¹‰
const LOCAL_DATA_PATH = '/static/data/data.json'
const CDN_DATA_URL = 'https://cdn.your-site.com/data.json'
const CACHE_KEY = 'cached_city_data'
const VERSION_KEY = 'data_version'
const USE_CDN = false

// âœ… æ–°å¢ï¼šå¼€å‘æ¨¡å¼å¼€å…³ (è§£å†³ç—›ç‚¹æ ¸å¿ƒ)
// true  = å¼€å‘æ¨¡å¼ï¼šæ— è§†ç‰ˆæœ¬å·ï¼Œå¼ºåˆ¶æ¯æ¬¡è¯»å–æœ€æ–°æ•°æ® (ä¿®æ”¹æ•°æ®åä¸ç”¨æ”¹versionä¹Ÿèƒ½ç”Ÿæ•ˆ)
// false = ç”Ÿäº§æ¨¡å¼ï¼šå¼€å¯ç¼“å­˜ç­–ç•¥ (ç‰ˆæœ¬å·ä¸€è‡´æ—¶ç›´æ¥ç”¨ç¼“å­˜ï¼Œæ€§èƒ½æ›´å¥½)
const IS_DEV = true 

// utils/dataLoader.uts

export async function loadCityData(): Promise<CityData> {
  try {
    const cachedData = getCachedData()
    // ğŸ”ª ä¿®æ”¹è¿™é‡Œï¼šåŠ ä¸Šæ—¶é—´æˆ³å‚æ•° ?t=xxx
        // è¿™æ ·æµè§ˆå™¨ä¼šè®¤ä¸ºæ¯æ¬¡éƒ½æ˜¯è¯·æ±‚ä¸€ä¸ªå…¨æ–°çš„æ–‡ä»¶ï¼Œç»å¯¹ä¸ä¼šè¯»ç¼“å­˜ï¼
        const timeStamp = Date.now()
        const originalUrl = (USE_CDN ? CDN_DATA_URL : LOCAL_DATA_PATH) as string
        const dataUrl = `${originalUrl}?t=${timeStamp}`
        
        console.log('ğŸ“¡ [1] å¼ºåˆ¶è¯·æ±‚æ–°åœ°å€:', dataUrl) // ä½ ä¼šçœ‹åˆ°ç±»ä¼¼ /data.json?t=170123456789
    
        const freshData = await fetchData(dataUrl)

    console.log('âœ… [2] æ–°æ–‡ä»¶è¯»å–æˆåŠŸï¼Œç‰ˆæœ¬å·:', freshData.version) // ğŸ” æ£€æŸ¥ç‚¹ 2

    // ... (ä½ çš„ç‰ˆæœ¬åˆ¤æ–­é€»è¾‘ï¼Œç•¥) ...
    // å¦‚æœèµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜æ–°æ•°æ®æ²¡é—®é¢˜
    
    if (!IS_DEV && cachedData != null && cachedData.version == freshData.version) {
       console.log('ğŸ“¦ ä½¿ç”¨ç¼“å­˜ (ç‰ˆæœ¬ä¸€è‡´)')
       return cachedData
    }
    
    console.log('ğŸ”„ æ›´æ–°ç¼“å­˜ä¸ºæ–°ç‰ˆæœ¬')
    saveToCache(freshData)
    return freshData

  } catch (error) {
    // ğŸš¨ğŸš¨ğŸš¨ è¿™é‡Œæ˜¯æ¡ˆå‘ç°åœº ğŸš¨ğŸš¨ğŸš¨
    console.error('âŒâŒâŒ [ä¸¥é‡] æ–°æ•°æ®è¯»å–å¤±è´¥ï¼ï¼ï¼åŸå› å¦‚ä¸‹:')
    console.error(error) 
    console.error('----------------------------------------')

    const cachedData = getCachedData()
    if (cachedData != null) {
      console.log('âš ï¸ [å…œåº•] å› ä¸ºè¯»å–å¤±è´¥ï¼Œç³»ç»Ÿè¢«è¿«ä½¿ç”¨äº†ã€æ—§ç¼“å­˜ã€‘')
      console.log('âš ï¸ [å…œåº•] æ—§ç¼“å­˜ç‰ˆæœ¬:', cachedData.version)
      return cachedData
    }
    throw new Error('æ— æ³•åŠ è½½æ•°æ®')
  }
}

async function fetchData(url: string): Promise<CityData> {
  // âœ… ä¿®å¤ç‚¹ï¼šåœ¨ Promise åæ˜¾å¼åŠ ä¸Š <CityData>
  // å‘Šè¯‰ç¼–è¯‘å™¨ï¼šè¿™ä¸ª Promise æœ€ç»ˆä¸€å®šä¼š resolve ä¸€ä¸ª CityData ç±»å‹çš„æ•°æ®
  return new Promise<CityData>((resolve, reject) => {
    uni.request({
      url: url,
      method: 'GET',
      success: (res) => {
        if (res.statusCode == 200) {
            try {
                // 1. è½¬ JSON å­—ç¬¦ä¸²
                const jsonStr = JSON.stringify(res.data)
                
                // 2. è§£æå¹¶æ–­è¨€
                // æ³¨æ„ï¼šè¿™é‡Œ data å¯èƒ½æ˜¯ nullï¼Œæ‰€ä»¥å®šä¹‰ä¸º CityData | null
                const data = JSON.parse<CityData>(jsonStr) as CityData | null
                
                // 3. éç©ºæ£€æŸ¥
                if (data != null) {
                    // âœ… å› ä¸ºä¸Šé¢åšäº†éç©ºæ£€æŸ¥ï¼Œè¿™é‡Œ data è¢«æ™ºèƒ½è½¬æ¢ä¸º CityData
                    // æ­£å¥½åŒ¹é… Promise<CityData> çš„è¦æ±‚
                    resolve(data)
                } else {
                    reject("æ•°æ®è§£æä¸ºç©º")
                }
            } catch (e) {
                reject(`è§£æå¼‚å¸¸: ${e}`)
            }
        } else {
            reject(`è¯·æ±‚å¤±è´¥: ${res.statusCode}`)
        }
      },
      fail: (err) => reject(err)
    })
  })
}

function getCachedData(): CityData | null {
  try {
    const val = uni.getStorageSync(CACHE_KEY)
    if (val != null) {
        const jsonStr = val as string
        if (jsonStr != "") {
             return JSON.parse(jsonStr) as CityData
        }
    }
    return null
  } catch (error) {
    return null
  }
}

function saveToCache(data: CityData): void {
  try {
    const jsonStr = JSON.stringify(data)
    uni.setStorageSync(CACHE_KEY, jsonStr)
  } catch (error) {
    console.error('ç¼“å­˜ä¿å­˜å¤±è´¥:', error)
  }
}

export function clearCache(): void {
  try {
    uni.removeStorageSync(CACHE_KEY)
    uni.removeStorageSync(VERSION_KEY)
    console.log('ğŸ—‘ï¸ ç¼“å­˜å·²æ‰‹åŠ¨æ¸…é™¤')
  } catch (error) { }
}