// utils/dataLoader.uts
import { CityData } from '../types/city'

// 1ï¸âƒ£ å…³é”®ç‚¹ï¼šç›´æ¥æŠŠæœ¬åœ° JSON ä½œä¸ºä¸€ä¸ªæ¨¡å—å¼•å…¥è¿›æ¥
// åªè¦ä½ ä¿®æ”¹äº† json æ–‡ä»¶å¹¶ä¿å­˜ï¼ŒHBuilderX ä¼šè‡ªåŠ¨çƒ­é‡è½½ï¼Œä¸éœ€è¦æ‰‹åŠ¨åŠ æ—¶é—´æˆ³
import localJsonData from '@/static/data/data.json'

// å¸¸é‡å®šä¹‰
const CDN_DATA_URL = 'https://cdn.your-site.com/data.json'
const CACHE_KEY = 'cached_city_data'
const USE_CDN = false // ğŸ‘ˆ å¦‚æœæ˜¯ falseï¼Œä»£ç ä¼šè‡ªåŠ¨èµ° import é€»è¾‘

// å¼€å‘æ¨¡å¼å¼€å…³
const IS_DEV = true 

export async function loadCityData(): Promise<CityData> {
  try {
    // ---------------------------------------------------------
    // åˆ†æ”¯ A: æœ¬åœ°æ•°æ®æ¨¡å¼ (æœ€ç¨³ï¼Œä¸ä¼šæŠ¥é”™)
    // ---------------------------------------------------------
    if (!USE_CDN) {
      console.log('ğŸ“‚ [Local] æ£€æµ‹åˆ°é…ç½®ä¸ºæœ¬åœ°æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨ import å†…å®¹')
      // å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œç¡®ä¿ç¬¦åˆ CityData ç»“æ„
      const localData = JSON.parse(JSON.stringify(localJsonData)) as CityData
      return localData
    }

    // ---------------------------------------------------------
    // åˆ†æ”¯ B: CDN ç½‘ç»œæ¨¡å¼ (æ‰éœ€è¦æ—¶é—´æˆ³é˜²ç¼“å­˜)
    // ---------------------------------------------------------
    const cachedData = getCachedData()
    
    // åªæœ‰åœ¨è¯·æ±‚è¿œç¨‹ CDN æ—¶ï¼ŒåŠ æ—¶é—´æˆ³æ‰æœ‰æ„ä¹‰ä¸”åˆæ³•
    const timeStamp = Date.now()
    const dataUrl = `${CDN_DATA_URL}?t=${timeStamp}`
    
    console.log('ğŸ“¡ [Remote] æ­£åœ¨è¯·æ±‚è¿œç¨‹ CDN:', dataUrl)

    const freshData = await fetchData(dataUrl)

    console.log('âœ… [Remote] ä¸‹è½½æˆåŠŸï¼Œç‰ˆæœ¬:', freshData.version)

    // ç¼“å­˜ç­–ç•¥æ£€æŸ¥
    if (!IS_DEV && cachedData != null && cachedData.version == freshData.version) {
       console.log('ğŸ“¦ ä½¿ç”¨ç¼“å­˜ (ç‰ˆæœ¬ä¸€è‡´)')
       return cachedData
    }
    
    console.log('ğŸ”„ æ›´æ–°ç¼“å­˜')
    saveToCache(freshData)
    return freshData

  } catch (error) {
    console.error('âŒâŒâŒ [ä¸¥é‡] æ•°æ®åŠ è½½å¤±è´¥:', error)
    
    // å…œåº•é€»è¾‘
    const cachedData = getCachedData()
    if (cachedData != null) {
      console.log('âš ï¸ [å…œåº•] ä½¿ç”¨æ—§ç¼“å­˜')
      return cachedData
    }
    throw new Error('æ— æ³•åŠ è½½æ•°æ®')
  }
}

// è¿™ä¸ªå‡½æ•°åªè´Ÿè´£ç½‘ç»œè¯·æ±‚
async function fetchData(url: string): Promise<CityData> {
  return new Promise<CityData>((resolve, reject) => {
    uni.request({
      url: url,
      method: 'GET',
      success: (res) => {
        if (res.statusCode == 200) {
            try {
                // å¤„ç†è¿”å›çš„æ•°æ®å¯èƒ½æ˜¯ string æˆ– object çš„æƒ…å†µ
                let data: CityData | null = null
                if (typeof res.data === 'string') {
                     data = JSON.parse<CityData>(res.data as string)
                } else {
                     // å¦‚æœå·²ç»æ˜¯å¯¹è±¡ï¼Œå…ˆè½¬å­—ç¬¦ä¸²å†è½¬å›æ¥æˆ–è€…ç›´æ¥æ–­è¨€ï¼ˆä¸ºäº†å®‰å…¨å»ºè®®æ·±æ‹·è´ä¸€æ¬¡ï¼‰
                     const jsonStr = JSON.stringify(res.data)
                     data = JSON.parse<CityData>(jsonStr)
                }

                if (data != null) {
                    resolve(data)
                } else {
                    reject("æ•°æ®è§£æä¸ºç©º")
                }
            } catch (e) {
                reject(`è§£æå¼‚å¸¸: ${e}`)
            }
        } else {
            reject(`è¯·æ±‚å¤±è´¥: ${res.statusCode}`)
        }
      },
      fail: (err) => reject(err)
    })
  })
}

function getCachedData(): CityData | null {
  try {
    const val = uni.getStorageSync(CACHE_KEY)
    if (val != null && val !== "") {
        return JSON.parse(val as string) as CityData
    }
    return null
  } catch (error) {
    return null
  }
}

function saveToCache(data: CityData): void {
  try {
    const jsonStr = JSON.stringify(data)
    uni.setStorageSync(CACHE_KEY, jsonStr)
  } catch (error) {
    console.error('ç¼“å­˜ä¿å­˜å¤±è´¥:', error)
  }
}

export function clearCache(): void {
  try {
    uni.removeStorageSync(CACHE_KEY)
    console.log('ğŸ—‘ï¸ ç¼“å­˜å·²æ¸…é™¤')
  } catch (error) { }
}